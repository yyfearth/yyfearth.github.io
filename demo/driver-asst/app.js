(function(){var k,h,n,o,p,f,q,m,r,j,s,l,t,u,v;window.offline_mode=!navigator.onLine;$(document).bind("mobileinit",function(){return $.mobile.touchOverflowEnabled=!0});window.app={back:function(){return history.go(-1)},autologin:"on"===$("#autologin").val(),offline:function(){return window.offline_mode||!navigator.onLine}};(function(){return window.offline_mode&&navigator.onLine?confirm("You are online now, \npress OK to reload the App and enable online features!")?location.reload():setTimeout(arguments.callee,
6E4):setTimeout(arguments.callee,1E4)})();app.offline()&&$(document.body).addClass("offline");applicationCache.onupdateready=function(){applicationCache.swapCache();if(confirm("Application has been updated just now.\nIn order to work properly, \nPLEASE CLICK OK to reload this Application as soon as possible."))return location.reload()};l={replace_regex:/<|>/g,replace_dict:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"},esc_regex:/\\[\/\\nbtvfr'"0(u\w{4})(x\w{2})]/g,esc_dict:{"\\":"\\",
"/":"/",'"':'"',"'":"'","0":"\x00",n:"\n",b:"\b",t:"\t",v:"\v",f:"\f",r:"\r"},url:function(a){return encodeURI(a)},attr:function(a){return a.toString().replace(/\W/g,function(a){var c;c=a.charCodeAt(0);return 255>c?"&#"+c+";":a})},js:function(a,b){var c=this;b||(a=a.replace(this.esc_regex,function(a){a=a.slice(1);return null!=c.esc_dict[a]?c.esc_dict[a]:String.fromCharCode(Number(a.clice(1)))}));return a.replace(/\W/g,function(a){var b;b=a.charCodeAt(0);return 255>b?(b=b.toString(16),2>b.length&&
(b="0"+b),"\\x"+b):a})},str:function(a){var b=this;return a.toString().replace(this.replace_regex,function(a){return b.replace_dict[a]})},json:function(a,b){var c;(c="string"===typeof a)||(a=JSON.stringify(a));a=this.str(a);return c||!b?a:JSON.parse(a)}};j=function(a,b){null!=a.svc&&null==b?(b=a,a=b.svc):"string"===typeof a&&(b.svc=a);b.type=null!=b.type&&/get/i.test(b.type)?"GET":"POST";b.nowait&&(b.background=!0);"POST"===b.type&&(b.data=l.json(b.data));b.background||$.mobile.showPageLoadingMsg();
console.log("fake svc",b);setTimeout(function(){var a;$.mobile.hidePageLoadingMsg();typeof b.complete==="function"&&b.complete();switch(b.svc){case "user":console.log(b.data);a={uid:1,sid:"00000000000000000000000000000000"};console.log(a);typeof b.callback==="function"&&b.callback(a)}},500);return!1};s=function(a){return $.ajax({url:"svc/weather.json",dataType:"json",success:function(b){return a(b)},error:function(a){return console.log("get weather failed",a)}})};h={fmt:function(a){return 9<a?a.toString():
"0"+a},dateToWcf:function(a){var b;b=(new Date).getTimezoneOffset()/60;return"/Date("+ +(Date.parse(a)-36E5*b)+(0<b?"-":"+")+(9<b?"":"0")+b+"00)/"},dateFromWcf:function(a){a=a.match(/^\/Date\((\d+)([+-]\d{2})(\d{2})\)\/$/);return 4!==a.length?null:new Date(Number(a[1]))},dateFromStr:function(a){return new Date(a.replace(/-/g,"/"))},dateToStr:function(a){a=new Date(a);return""+a.getFullYear()+"-"+this.fmt(a.getMonth()+1)+"-"+this.fmt(a.getDate())+" "+this.fmt(a.getHours())+":"+this.fmt(a.getMinutes())+
":"+this.fmt(a.getSeconds())},dateFromWcfToStr:function(a){return this.dateToStr(this.dateFromWcf(a))},dateToUTC:function(a){a=new Date(a);return""+a.getUTCFullYear()+"-"+this.fmt(a.getUTCMonth()+1)+"-"+this.fmt(a.getUTCDate())+"T"+this.fmt(a.getUTCHours())+":"+this.fmt(a.getUTCMinutes())+":"+this.fmt(a.getUTCSeconds())}};try{app.user=JSON.parse(sessionStorage.user||localStorage.user),0<(null!=(t=app.user)?t.uid:void 0)&&32===(null!=(u=app.user)?null!=(v=u.sid)?v.length:void 0:void 0)?(location.hash=
"#home",app.offline()||j("user",{method:"check",data:{uid:app.user.uid,sid:app.user.sid},callback:function(a){console.log("check",a);a||$.mobile.changePage("#login",{transition:"none"});return null}})):location.hash="#login"}catch(w){app.user=null,location.hash="#login"}console.log("app.user",app.user);app.save_profile=window.onbeforeunload=function(){var a;null!=(a=app.user)&&a.uid?(a=sessionStorage.user=JSON.stringify(app.user),app.autologin&&(localStorage.user=a)):(localStorage.removeItem("user"),
sessionStorage.removeItem("user"))};app.reset=function(){app.db.reset();app.user=null;app.save_profile();window.onbeforeunload=$.noop;return location.reload()};$('[data-role="page"] [data-role="header"]:not(.ui-non-nav)').append($('[data-btn-role="back"],[data-btn-role="home"]'));$('#search [data-btn-role="home"]').hide();k=document.body;q=$(document.querySelectorAll('[data-role="map"]'));$(window).resize(function(){app.horizontal=k.clientWidth>k.clientHeight;return $(k)[app.horizontal?"addClass":
"removeClass"]("horizontal")});$(document.body).resize();f=app.map=null;app.offline()||(f=app.map=new google.maps.Map($("#map")[0],{zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP,navigationControl:!0,navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}}),f.plcsvc=new google.maps.places.PlacesService(f),f.geocoder=new google.maps.Geocoder,f.dirsvc=new google.maps.DirectionsService,f.dirrdr=new google.maps.DirectionsRenderer,f.svbounds=new google.maps.LatLngBounds(new google.maps.LatLng(38.052417,
-122.728271),new google.maps.LatLng(37.247821,-121.552734)),function(){var a=this;this.el=$("#map");(new google.maps.TrafficLayer).setMap(this);return $.extend(this,{setMarkers:function(b){b?$.isArray(b)||(b=[b]):b=null;null!=a.markers&&a.markers.forEach(function(a){return a.setMap(null)});a.markers=null!=b?b.map(function(a){a.map=f;return new google.maps.Marker(a)}):null;return a},getCurPos:function(b,c){null==c&&(c=b,b=!0);app.offline()?c.call(a,null,null):null!=navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){var d;
d=f.lastlatlng=new google.maps.LatLng(e.coords.latitude,e.coords.longitude);if(!d.equals(a.getCenter()))d.changed=true;if(b&&d.changed){a.setMarkers(null);a.setCenter(d);q.each(function(b,c){return $(c).css("background-image","url('//maps.googleapis.com/maps/api/staticmap?center="+d.lat()+","+d.lng()+"&zoom="+($(c).attr("data-map-zoom")||15)+"&size="+$(window).width()+"x"+a.el.height()+"&maptype=roadmap&format=png8&sensor=true&language=en')")});return f.geocoder.geocode({latLng:d},function(b,e){var f;
e===google.maps.GeocoderStatus.OK?c.call(a,d,(f=b[0])!=null?f.formatted_address:void 0):alert("Geocoder failed due to: "+e+"\n App terminated!");return a.setCenter(d)})}return c.call(a,d)},function(){return alert("App cannot run without geo location!")});return a}})}.call(f),$('[data-role="page"]').bind({pagebeforeshow:function(){f.el.addClass("hidden");return $(document.body)[app.offline()?"addClass":"removeClass"]("offline")},pageshow:function(){var a,b;$.mobile.fixedToolbars.show(!0);this.hh=(null!=
(a=$('[data-role="header"]',this))?a.outerHeight():void 0)||0;this.fh=(null!=(b=$('[data-role="footer"]',this))?b.outerHeight():void 0)||0;this.bh=document.body.clientHeight-this.hh-this.fh;f.el.css("top",this.hh);$(".map",this).add(f.el).height(this.bh*(app.horizontal?1:0.45));if($(this).hasClass("has-map"))return f.el.removeClass("hidden")}}));app.sync_weather=function(){var a;a=function(a){var c,e;if(((c=a.weather)!=null?c.current_conditions:void 0)!=null){c=a.weather.current_conditions;console.log("weather",
a);e=function(a){return"//www.google.com"+a.icon.data};c=$("#weather").html('<div id="weather_now" class="weather"><img src="'+e(c)+'"/>'+c.condition.data+"<br/>"+c.temp_f.data+"\u00b0F</div>");c.append(a.weather.forecast_conditions.map(function(a){return'<div class="weather"><img src="'+e(a)+'"/>'+a.day_of_week.data+" "+a.high.data+"/"+a.low.data+"\u00b0F</div>"}).join(""))}else $("#weather").html("(No Weather Data)");return this};return app.offline()?localStorage.weather!=null?a(JSON.parse(localStorage.weather)):
a(null):s(function(b){localStorage.weather=JSON.stringify(b);return a(b)})};null!=window.openDatabase&&(app.db=openDatabase("KnightRider","1.0","Data cache for Knight Rider",2E5),null!=app.db?(app.db._onerr=function(a,b){return console.error("local db error",a,b)},app.db.reset=function(){return app.db.transaction(function(a){a.executeSql("DROP TABLE IF EXISTS Alerts;");return a.executeSql("DROP TABLE IF EXISTS Place;")})},app.db.sync=function(a,b){console.log("sync",a);a=a.toLowerCase();app.db.transaction(function(c){return c.executeSql("SELECT modified FROM ["+
a+"] WHERE id=0",[],function(c,d){var g;g=d.rows.item(0);console.log("last",a,g);return j(a,{method:"sync",type:"get",background:true,data:{last:h.dateToStr(g.modified.replace(/-/g,"/"))},callback:function(d){console.log("sync",a,d);return typeof b==="function"?b(d):void 0}})})});return this},p=function(a,b){var c,e,d;d=[];for(c=a.length;c;){e=$.extend({},a.item(--c));e.created=new Date(e.created.replace(/-/g,"/"));e.modified=new Date(e.modified.replace(/-/g,"/"));typeof b==="function"&&b(e);d.unshift(e)}return d},
o=function(a){return p(a,function(a){a.canappt=/true/i.test(a.canappt);return a.location={lat:a.lat,lng:a.lng}})},n=function(a,b){a.executeSql("SELECT * FROM [Alerts] WHERE status=1 and expired > DATETIME('now','localtime')ORDER BY datetime DESC, importance DESC;",[],function(a,e){var d;d=p(e.rows,function(a){a.datetime=new Date(a.datetime.replace(/-/g,"/"));return a.expired=new Date(a.expired.replace(/-/g,"/"))});console.log("alerts from db",d,e);return typeof b==="function"?b(d,"alerts"):void 0},
app.db._onerr);return this},app.db.sync_alerts=function(a){app.offline()?app.db.transaction(function(b){return n(b,a)}):app.db.sync("alerts",function(b){app.db.transaction(function(c){var e,d;if(b.length){e=b.map(function(a){return a.id});d=b.map(function(a){return[a.id,a.summary,a.message,h.dateFromWcfToStr(a.datetime),h.dateFromWcfToStr(a.expired),a.importance,a.type,a.status,h.dateFromWcfToStr(a.created),h.dateFromWcfToStr(a.modified)]});console.log("db","INSERT INTO [Alerts](id,summary,message,datetime,expired,importance,type,status,created,modified) VALUES (?,?,?,?,?,?,?,?,?,?);",
d);c.executeSql("DELETE FROM [Alerts] WHERE id IN ("+e.join(",")+")");d.forEach(function(a){return c.executeSql("INSERT INTO [Alerts](id,summary,message,datetime,expired,importance,type,status,created,modified) VALUES (?,?,?,?,?,?,?,?,?,?);",a)});c.executeSql("UPDATE [Alerts] SET modified=DATETIME('now','localtime') WHERE id=0")}n(c,a);return this});return this});return this},app.db.sync_place=function(){if(!app.offline())return app.db.sync("place",function(a){if(a.length)return app.db.transaction(function(b){var c,
e;c=a.map(function(a){return a.id});e=a.map(function(a){return[a.id,a.gid,a.name,a.location.lat,a.location.lng,a.vicinity,a.fulladdr,a.phone,a.email,a.website,a.rating,a.gtypes,a.svctypes,a.openhours,a.canappt,a.status,h.dateFromWcfToStr(a.created),h.dateFromWcfToStr(a.modified)]});console.log("db","INSERT INTO [Place](id,gid,name,lat,lng,vicinity,fulladdr,phone,email,website,rating,gtypes,svctypes,openhours,canappt,status,created,modified)VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);",e);b.executeSql("DELETE FROM [Place] WHERE id IN ("+
c.join(",")+")");e.forEach(function(a){return b.executeSql("INSERT INTO [Place](id,gid,name,lat,lng,vicinity,fulladdr,phone,email,website,rating,gtypes,svctypes,openhours,canappt,status,created,modified)VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);",a,null,app.db._onerr)});return b.executeSql("UPDATE [Place] SET modified=DATETIME('now','localtime') WHERE id=0")})})},app.db.query_place=function(a,b){app.db.transaction(function(c){return c.executeSql("SELECT * FROM [Place] WHERE status<>0 and svctypes&"+
a+"<>0;",[],function(a,c){var g;g=o(c.rows);console.log("place from db",g,c);return typeof b==="function"?b(g):void 0},app.db._onerr)});return this},app.db.get_place=function(a,b){$.isArray(a)||(a=[a]);app.db.transaction(function(c){return c.executeSql("SELECT * FROM [Place] WHERE gid in ('"+a.join("','")+"');",[],function(a,c){var g;g=o(c.rows);return typeof b==="function"?b(g):void 0},app.db._onerr)});return this},app.db.transaction(function(a){console.log("init tables");a.executeSql("CREATE TABLE IF NOT EXISTS [Alerts] (id int not null primary key, summary nvarchar(100) not null, message text, datetime datetime, expired datetime, importance tinyint not null, type tinyint not null, status tinyint not null,created datetime not null, modified datetime not null);");
a.executeSql("CREATE INDEX IF NOT EXISTS [Alerts_ODR] ON [Alerts] (datetime DESC, importance DESC);");a.executeSql("INSERT INTO [Alerts](id,summary,importance,type,status,created,modified)SELECT 0,'LastUpdate',0,0,0,DATETIME('now','localtime'),DATETIME(0,'unixepoch','localtime')WHERE NOT EXISTS(SELECT * FROM [Alerts] WHERE id=0);");a.executeSql("CREATE TABLE IF NOT EXISTS [Place] (id int not null primary key, gid char(40),name nvarchar(100),lat float,lng float,vicinity nvarchar(200),fulladdr nvarchar(1000),phone varchar(15),email varchar(100),website varchar(100),rating tinyint,gtypes varchar(100),svctypes tinyint not null,openhours text,canappt bit not null,status tinyint not null,created datetime not null,modified datetime not null);");
a.executeSql("CREATE UNIQUE INDEX IF NOT EXISTS [Place_GID] ON [Place] (GID);");a.executeSql("CREATE INDEX IF NOT EXISTS [Place_TYP] ON [Place] (svctypes);");return a.executeSql("INSERT INTO [Place](id,name,canappt,svctypes,status,created,modified)SELECT 0,'LastUpdate',0,0,0,DATETIME('now','localtime'),DATETIME(0,'unixepoch','localtime')WHERE NOT EXISTS(SELECT * FROM [Place] WHERE id=0);")})):alert("open db err"));$("#home").bind({pagecreate:function(){return this.created=true},pagebeforeshow:function(){app.offline()?
$("#home_addr").text("You are offline now"):window.offline_mode||f.getCurPos(function(a,b){b!=null&&$("#home_addr").text(b);this.setZoom(15);return this.setMarkers({position:a})});app.sync_weather();app.db.sync_place();app.db.sync_alerts(function(a){var b;console.log("alerts",a);$("#alerts").empty();b='<li data-role="list-divider" class="ui-body-c list-none">No Alerts</li>';a.length>0&&(b='<li data-role="list-divider" class="ui-body-c list-none">'+a.length+" Alerts</li>"+a.map(function(a){return"<li><a href=\"javascript:alert('"+
l.js("Summary: "+a.summary+"\\nMessage: "+a.message+"\\nFrom: "+a.datetime+"\\nExpire: "+a.expired)+"')\">"+a.summary+" ("+a.datetime.toLocaleDateString()+")</a></li>"}).join(""));return $("#alerts").html(b).listview().listview("refresh")});return this},pageshow:function(){var a;a=$("#alerts");return a.height(document.body.clientHeight-a.offset().top-this.fh)}});$("#login").bind({pagecreate:function(){$("#login_form").submit(function(a){var b,c,e,d,g;a.preventDefault();a.stopPropagation();if(app.offline())return false;
e=$("input",this).textinput("disable");g=$("select",this).slider("disable");b=$("button",this).button("disable");$("#btn_reg").addClass("ui-disabled");c=$("#email").val().trim();a=$("#password").val();if(!c||!a)return false;d=c.toLowerCase()+a;app.autologin=$("#autologin").val()==="on";j("user",{method:"login",data:{email:c,password:d},callback:function(a){var b;if(a.uid&&((b=a.sid)!=null?b.length:void 0)===32){app.user={uid:a.uid,email:c,sid:a.sid,psw:a.sid+a.uid+d};app.save_profile();return $.mobile.changePage("#home",
{transition:"flip"})}return alert("Login Failed, please try again")},complete:function(){b.button("enable");e.textinput("enable");g.slider("enable");return $("#btn_reg").removeClass("ui-disabled")}});return false});return this},pagebeforehide:function(){return $("#login_form_warp").hide()},pagebeforeshow:function(){return $("#login_form_warp").hide()},pageshow:function(){$("#password").val("");$("#login_form_warp").show();if(app.offline()){$("button",this).button("disable");$("#btn_reg").addClass("ui-disabled");
app.offline()&&alert("You are offline now!\nLogin need a network.")}else{$("button",this).button("enable");$("#btn_reg").removeClass("ui-disabled");if(app.user==null)return;console.log("logout",app.user);j("user",{method:"logout",nowait:true,data:{uid:app.user.uid,sid:app.user.sid}});app.user=null;app.save_profile()}return this}});$("#reg_form").submit(function(a){var b,c;a.preventDefault();a.stopPropagation();if(app.offline())return false;if(this.password.value!==this.password2.value){alert("Password does not match!");
this.password2.focus();return false}a=this.email.value.trim();b=this.password.value;b=a.toLowerCase()+b;c={email:a,password:b,fullname:{first:this.first.value.trim(),last:this.last.value.trim()},phone:this.phone.value.trim()};if(/[<>"]/.test(c.email+c.first+c.last+c.phone)){alert('Invalid charactors: < > and " found');return false}console.log("reg",c);j("user",{method:"reg",data:{user:c},callback:function(a){console.log("new id:",a);if(a<1)return alert("Email already exists!");$("#email").val(c.email);
$("#reg").dialog("close");return alert("Registration successful!")}});return false});$("#appointment").bind({pagebeforeshow:function(){var a,b;if(app.offline())return app.back();$("#datetime").val(Date((new Date).getTime()+36E5).toLocaleString());((a=app.user)!=null?(b=a.sid)!=null?b.length:void 0:void 0)!==32&&$.mobile.changePage("#login",{transition:"flip",reverse:true});return false}});$("#appt_form").submit(function(a){var b,c,e;if(((b=app.user)!=null?(c=b.sid)!=null?c.length:void 0:void 0)!==
32||((e=app.user)!=null?e.uid:void 0)===0||app.offline())return false;a.preventDefault();a.stopPropagation();a={user:app.user.uid,place:app.selected_place.gid,contact:{name:this.name.value,phone:this.phone.value},datetime:h.dateToWcf(this.datetime.value),message:this.comments.value};console.log("appt",a);j("appointment",{method:"add",data:{appt:a,sid:app.user.sid},callback:function(a){console.log("appt success:",a);if(a){$("#appointment").dialog("close");return alert("Appointment sent successful!")}return $.mobile.changePage("#login",
{transition:"flip",reverse:true})}});return false});$("#search").bind({pageshow:function(){return $("#btn_custom_search")[app.offline()?"addClass":"removeClass"]("ui-disabled")}});$('[data-btn-role="search"]').live({vclick:function(){app.search_keyword=$(this).text();return this}});app.custom_search_history_refresh=function(){var a,b;$("#custom_history_list li:gt(0)").remove();a='<li data-role="list-divider" class="ui-body-c list-none">(None)</li>';if((b=app.user.custom_search_history)!=null&&b.length)a=
app.user.custom_search_history.map(function(a){return'<li><a href="#result" data-btn-role="search">'+a+"</a></li>"}).join("");return $("#custom_history_list_header").after(a)};app.place_search_history_refresh=function(){var a,b;$("#search_history_list li:gt(0)").remove();a='<li data-role="list-divider" class="ui-body-c list-none">(None)</li>';if((b=app.user.place_search_history)!=null&&b.length)a=app.user.place_search_history.map(function(a,b){var d;d=a.icon!=null&&!app.offline()?'<img src="'+a.icon+
'" class="ui-li-icon"/>':"";return'<li><a href="#detail" data-btn-role="result" data-index="'+b+'">'+d+'<h3 class="ui-li-heading">'+a.name+'</h3><p class="ui-li-desc">'+a.vicinity+"</p></li>"}).join("");return $("#search_history_list_header").after(a)};$("#custom_search").bind({pagecreate:function(){this.created=true;app.custom_search_history_refresh();if(!app.offline())return new google.maps.places.Autocomplete($("#input_search")[0],{bounds:f.svbounds,types:["establishment"]})},pagebeforeshow:function(){if(app.offline())return app.back()}});
$("#custom_search").bind("pageshow pagebeforeshow",function(){if(this.created)return $("#custom_history_list").listview("refresh")});$("#custom_search_form").submit(function(){var a,b;a=$("#input_search");if(b=$.trim(a.val())){app.search_keyword=new String(b);$.mobile.changePage("#result")}else a.focus().val("");return false});$("#search_history").bind({pagecreate:function(){this.created=true;app.place_search_history_refresh();return $("#search_history li a").live({vclick:function(){return app.selected_place=
app.user.place_search_history[Number($(this).attr("data-index"))]}})}});$("#search_history").bind("pageshow pagebeforeshow",function(){if(this.created)return $("#search_history_list").listview("refresh")});m={"Service Station":2,"Gas Station":4,"Towing Station":8,"Vehicle Repair Station":16};$("#result").bind({pageshow:function(){var a;a=$("#result_list");a.height(document.body.clientHeight-a.offset().top);return this},pagebeforeshow:function(){var a,b,c;console.log("search for",app.search_keyword);
if(app.search_keyword){$.mobile.showPageLoadingMsg();b=function(a,b){app.result_map={};console.log("sort",a,b);a.forEach(function(a){var c,e;app.result_map[a.gid]=a;e=a.location.lng-b.lng;c=a.location.lat-b.lat;return a.dist=Math.pow(e,2)+Math.pow(c,2)});a.sort(function(a,b){return a.dist-b.dist});return a.slice(0,25)};a=$("#result_list").empty();c=$(this);app.offline()?m[app.search_keyword]==null?alert("You are offline now.\nCustom Search is disabled"):app.db.query_place(m[app.search_keyword],function(e){var d;
d=function(d){if(d!=null)e=b(e,{lat:d.coords.latitude,lng:d.coords.longitude});else c.one({pageshow:function(){return alert("Cannot get your current location while offline.\nThe results is unsorted and maybe not nearby.\nIn another word, the 1st result does not means the nearest.\nYou need select the place by yourself.")}});$("#result_addr").text("[Offline] "+app.search_keyword+" ("+e.length+")");a.append(e.map(function(a,b){var c;c=d!=null?'<div style="float:left">'+String.fromCharCode(65+b)+"</div>":
"";return'<li><a href="#detail" data-btn-role="result" id="'+a.gid+'">'+c+'<h3 class="ui-li-heading">'+a.name+'</h3><p class="ui-li-desc">'+a.vicinity+"</p></li>"}).join(""));a.listview("refresh");return this};navigator.geolocation!=null&&navigator.geolocation.getCurrentPosition(function(a){return d(a)},function(){var a;return d((a=app.map)!=null?a.lastlatlng:void 0)});return this}):f.getCurPos(function(c){this.setZoom(12);return f.plcsvc.search({location:c,radius:5E3,keyword:app.search_keyword},
function(d,g){var i,h,j;if(g===google.maps.places.PlacesServiceStatus.ZERO_RESULTS){alert("Zero Result");app.back()}else if(g===google.maps.places.PlacesServiceStatus.OK){d.forEach(function(a){a.gid=a.id;return a.location={lat:a.geometry.location.lat(),lng:a.geometry.location.lng()}});d=b(d,{lat:c.lat(),lng:c.lng()});$("#result_addr").text(""+app.search_keyword+" ("+d.length+")");a.append(d.map(function(a,b){var c;a.seq=String.fromCharCode(65+b);return'<li><a href="#detail" data-btn-role="result" id="'+
a.id+'"><div style="float:left">'+a.seq+'</div><img src="'+((c=a.icon)!=null?c.replace(/^http:/,""):void 0)+'" class="ui-li-icon"/><h3 class="ui-li-heading">'+a.name+'</h3><p class="ui-li-desc">'+a.vicinity+"</p></li>"}).join(""));a.listview("refresh");i=d.reverse().map(function(a){return{position:a.geometry.location,icon:"//www.google.com/mapfiles/marker"+a.seq+".png",title:a.name}});i.push({position:c,icon:"//www.google.com/mapfiles/arrow.png",title:"You are here"});f.setMarkers(i);if(m[app.search_keyword]==
null){i=(j=(h=app.user).custom_search_history)!=null?j:h.custom_search_history=[];if(i.length===0||i[0]!==app.search_keyword){i.unshift(app.search_keyword);app.custom_search_history_refresh()}}}else alert("Search Error");return this})});return this}app.back()}});r=function(a){var b,c,a=Number(a);c=a.toFixed(1);b=a|0;b>0&&(c=c+(" "+Array(b+1).join('<img src="res/star.png"/>')));a-b>0.4&&(c=c+'<img src="res/halfstar.png"/>');return c};$("#result_list a").live({vclick:function(){return app.selected_place=
app.result_map[this.id]}});$("#detail").bind({pagecreate:function(){return $("#apt_cancel").bind({vclick:function(a){a.preventDefault();a.stopPropagation();$("#appointment").dialog("close");return false}})},pageshow:function(){var a,b,c;a=$("#detial_info").empty();a.height(document.body.clientHeight-a.offset().top-this.fh);console.log("start get detail of",app.selected_place);window.scrollTop=0;if(app.selected_place){$('[data-role="navbar"]',this)[app.offline()?"hide":"show"]();c=function(b){var c,
g,i,h,j,k;console.log("show detail",b);if(!app.offline())$("#btn_appt")[!b.canappt?"addClass":"removeClass"]("ui-disabled");if(app.map!=null){c=((g=b.geometry)!=null?g.location:void 0)||new google.maps.LatLng(b.location.lat,b.location.lng);f.setCenter(c);f.setMarkers({position:c});f.setZoom(15)}$("#detail_place").text(b.name);c="Visit its Website";if(b.website!=null){if(/^place:\d+/.test(b.website)){b.website=b.website.replace("place:","http://maps.google.com/maps/place?cid=");c="View on Google Place"}if(!/^http/.test(b.website))b.website=
"http://"+b.website}else{b.website=b.url;c="View on Google Place"}g=l.json(b,true);a.html("<ul><li>"+g.fulladdr+"</li><li>"+g.phone+"</li><li>"+g.gtypes.replace(/_/g," ").toUpperCase()+"</li><li>"+(g.rating!=null?r(g.rating):"(No Rating Yet)")+'</li><li><a href="'+l.attr(g.website)+'" target="_blank">'+c+"</a></li><li>This p "+(g.canappt?"CAN":"CANNOT")+" make Appointment</li>"+(app.offline()?"<li>You are offline now, neigher Appointment nor Direction is available!</li>":"")+"</ul>");i=(j=(h=app.user).place_search_history)!=
null?j:h.place_search_history=[];if(i.length===0||i[0].id!==app.selected_place.id){i.some(function(a,b){if(a.id===app.selected_place.id){i.splice(b,1);return true}return false});i.unshift({gid:b.gid,reference:app.selected_place.reference,name:b.name,vicinity:b.vicinity,icon:(k=b.icon)!=null?k.replace(/^http:/,""):void 0});app.place_search_history_refresh()}return this};b=app.selected_place;b.gtypes!=null?c(b):app.db.get_place(b.gid,function(a){if(a.length){a=a[0];$.extend(b,a);b.geometry={location:google.maps.LatLng(b.location.lat,
b.location.lng)};return c(b)}if(app.offline()){alert("You are offline now, and there is no this place's data on local database");return app.back()}return f.plcsvc.getDetails({reference:b.reference},function(a,e){if(e===google.maps.places.PlacesServiceStatus.OK){b.gid=a.id;b.fulladdr=a.formatted_address;b.phone=a.formatted_phone_number;b.gtypes=a.types.join(",");b.phone=a.phone;b.website=a.website;b.rating=a.rating;b.canappt=false;return c(b)}return alert("Get Details Failed")})});return this}app.back()}});
$("#direction").bind({pagebeforeshow:function(){var a;if(app.offline())app.back();else{a=$("#direction_panel");f.getCurPos(function(b,c){return f.dirsvc.route({origin:c,destination:app.selected_place.vicinity,travelMode:google.maps.DirectionsTravelMode.DRIVING,unitSystem:google.maps.DirectionsUnitSystem.IMPERIAL,provideRouteAlternatives:true},function(b,c){if(c===google.maps.DirectionsStatus.OK){f.dirrdr.setMap(f);f.dirrdr.setPanel(a[0]);return f.dirrdr.setDirections(b)}return alert("Directions failed: "+
c)})});return this}},pageshow:function(){var a;a=$("#direction_panel");a.height(document.body.clientHeight-a.offset().top);return this},pagehide:function(){return f.dirrdr.setMap(null)}});console.log(10,"Wilson")})()
