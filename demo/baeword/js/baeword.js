/*!
* baeword with Ext JS Library 3.0+
* Copyright(c) 2006-2009 Ext JS, LLC
* licensing@extjs.com
* http://www.extjs.com/license
* beaword powered by Wilson@yyfearth.com
* filename: baeword.js
*/
Ext.namespace("baeword");baeword.info={LAST_UPDATE:"2010-9-26 3:44:03",CODE_NAME:"Proto",APP_VER:"0.8",APP_NAME:"baeword",FX_VER:"ExtJS 3.2+",FX_ID:"ext322",BY:"yyfearth.com",EMAIL:"yyfearth@gmail.com",WEB_SITE:"http://yyfearth.com/",HOME:"http://yyfearth.appspot.com/apps/"};(function(e){function H(a){var b=g.getSelectionModel().getSelected(),c=b.get("rate"),d=true;if(a==null)c=c<0||c>5?5:c?0:-1;else if(a===" ")c<0||c>9?c=5:c--;else if(a==="*"){c=c>=0&&c<=9?-1:5;d=false}else{if(a=="+"||a=="-")a=a=="+";if(a===true||a===false)a?c++:c--;else if(typeof a!="number"){c=parseInt(a);c=isNaN(c)?-1:a}else{c=a;d=false}}if(c<-1)c=-1;else if(c>10)c=10;(c<0||c>9)&&d?Ext.Msg.confirm("Inactivate Confirmation","Do you really want to INACTIVATE the word <b>"+b.get("word")+"</b> ?",function(h){h=="yes"&&b.set("rate",c)}):b.set("rate",c);g.view.refresh()}function T(a){if(a==null)f.prefilter(function(){return false});else if(a===true)f.prefilter("*");else if(Ext.isNumber(a)){if(a in e.wordlist.cur.filters){arguments.callee(e.wordlist.cur.filters[a].filter);return false}}else if(Ext.isFunction(a))f.prefilter(a);else if(Ext.isObject(a)){var b=[],c;for(c in a)b.push({property:c,value:a[c]});f.prefilter(b)}else f.prefilter(function(){return false})}function X(a){if(a.length<1)return null;f.removedRecords=[];f.commitChanges();f.changed=0;e.wordlist.cur.setText(a);f.on("load",function(){t.change(j.filter[j.wordlist]||0,true)},this,{single:true});f.loadData(e.wordlist.cur.wordlist);return e.wordlist.cur.wordlist.length}function Y(a){if(a){var b=[],c=[],d=e.wordlist.cur.fields;f.getCount();for(a=0;a<d.length;a++)c.push(d[a].name);b.push(c.join("\t"));f.each(function(h){for(var m=[],k=0;k<d.length;k++)m.push(h.get(c[k]));b.push(m.join("\t").replace(/\s+$/,""))});return b.join("\n")}else return e.wordlist.cur.getText()}function I(){if(j.can_play_mp3)return true;if(typeof Audio=="undefined")return j.autosound=false;var a=new Audio;j.can_play_mp3=a.canPlayType("audio/mpeg;");j.autosound=!!j.can_play_mp3;return j.can_play_mp3}function Q(){if(!j.can_play_mp3)return false;if(!arguments.callee._audio){arguments.callee._audio=new Audio(U);arguments.callee._audio.load()}arguments.callee._audio.play();return false}function p(a){function b(d){if(p.sound){var h=p.sound;if(h.word==d){h.ended&&h.play();return false}else{h.pause();h.src=h.word="";delete p.sound}}}function c(d){function h(n){function C(v){if(!v)return[];return[v.charAt(0),(v.slice(0,2)+"_").slice(0,2),(v.slice(0,3)+"__").slice(0,3),v]}var r=new Audio,o=[C(n).join("/"),C("x"+n).join("/")];r.word=n;r.urls=["~/de/0/"+n+".mp3","~/de/0/"+n+"%401.mp3",String.format("~/lf/0/{0}%23_{1}_{2}.mp3",o[0],"us",1),"~/de/0/x"+n+".mp3",String.format("~/lf/0/{0}%23_{1}_{2}.mp3",o[1],"us",1),"~/de/0/!"+n+".mp3",String.format("~/lf/0/{0}%23_{1}_{2}.mp3",o[0],"us",2),String.format("~/lf/0/{0}%23_{1}_{2}.mp3",o[0],"gb",1),String.format("~/lf/0/{0}%23_{1}_{2}.mp3",o[0],"gb",2),String.format("~/lf/0/{0}%23_{1}_{2}.mp3",o[1],"gb",1),Z];r.urls.forEach(function(v){var V=document.createElement("source");V.setAttribute("src",v.replace("~",m));r.appendChild(V)});r.addEventListener("canplay",function(){/no_sound/.test(this.currentSrc)||(p.fixurl[this.word]=this.currentSrc.replace(m,"~"))},false);r.addEventListener("ended",function(){p.sound=new Audio(this.currentSrc)},false);return r}if(b(d)==false)return false;if(!p.fixurl)p.fixurl=J.get("fixurl")||{};var m="http://www.gstatic.com/dictionary/static/sounds",k=p.fixurl[d]||"~/de/0/"+d+".mp3",l=p.sound;k=k.replace("~",m);p.sound=l=new Audio(k);l.word=d;l.autoplay=true;l.addEventListener("error",function(){p.sound=h(this.word);p.sound.play()},false)}if(!j.can_play_mp3||!a)return false;a=a.replace(/\s/g,"_").replace(/\(.+?\)/g,"");p.sound_timeout=p.sound_timeout&&clearTimeout(p.sound_timeout)||setTimeout(function(){p.sound_timeout=null;c(a)},300)}function R(){f.changed=f.getModifiedRecords().length+f.removedRecords.length;f.autosave&&f.changed>10&&w();e.btnSave.setIconClass("icon-save")}function W(a,b,c,d){if(Ext.isFunction(a)){c=a;if(typeof b!="string")d=b;a=b=null}if(f.changed>0)if(f.autosave){w();c.call(d||window)}else Ext.Msg.confirm(a||"Save Changes","You have unsaved changes.<br/>"+b||"Save them NOW or they will be lost?",function(h){h=="yes"&&w();reset_cfm()});else c.call(d||window)}function w(){var a=f.getModifiedRecords();if(a.length||f.removedRecords.length){a.forEach(function(b){var c=b.get("id");b=b.getChanges();e.wordlist.cur.update(c,b)});f.removedRecords.forEach(function(b){e.wordlist.cur.update(b.get("id"),null)});e.wordlist.cur.save();f.removedRecords=[];f.commitChanges();f.changed=0;e.btnSave.setIconClass("icon-accept")}}function K(a){function b(c){document.title="baeword - rendering...";e.wordlist.cur=e.wordlist[c.id]=c;t.loadFilters(c.filters);f.loadData(c.wordlist);document.title="baeword - "+c.name;g.el.unmask()}if(!a)return false;g.el.mask("Loading...");document.title="baeword - loading...";setTimeout(function(){g.getSelectionModel().clearSelections(true);e.wordlist[a]?b(e.wordlist[a]):$load("bae-wordlist-"+a+".js",function(c){!c||c.id!=a?Ext.Msg.alert("Error","Loading wordlist data failed!"):b(new s(c))},e,15E3,function(){Ext.Msg.alert("Timeout","Loading wordlist data timeout!<br/>Maybe some problems occured.")},"baeword.load")},100)}function E(a){if(a){window.close();location.href=$}else Ext.Msg.confirm("Close Window","Are you sure to close baeword?<br/><i>While you confirmed, the entire window(page) will be closed.</i>",function(b){b=="yes"&&E(true)})}var U="res/err.mp3",$="index",z=new Ext.ux.state.StorageProvider({name:"bae",fallback:false}),F=new Ext.ux.state.StorageProvider({name:"cur"}),J=new Ext.ux.state.StorageProvider({name:"tmp",session:true,fallback:false}),j=(F.set("option",Ext.applyIf(F.get("option")||{},{autosave:true,autosound:true,hidden_para:true,defaultDict:"g",filter:{}})),F.get("option"));Ext.state.Manager.setProvider(F);Ext.BLANK_IMAGE_URL=Ext.SSL_SECURE_URL="images/blank.gif";Ext.BLANK_URL=Ext.isSecure?Ext.SSL_SECURE_URL:"about:blank";Ext.USE_NATIVE_JSON=true;Ext.enableListenerCollection=true;e.wordlist={};var x=[{dict:"g",url:["http://www.google.com/dictionary?langpair=en|zh-CN&q={word}","http://www.google.com.hk/dictionary?langpair=en|zh-CN&q={word}"],text:"Google Dictionary",iconCls:"icon-dict-g"},{dict:"w",url:["http://yyfearth.appspot.com/webster/{word}","http://gae.yyfearth.com/webster/{word}"],text:"Merriam-Webster(LE)",iconCls:"icon-dict-w"},{dict:"mw",url:"http://www.merriam-webster.com/dictionary/{word}",text:"Merriam-Webster(Full)",iconCls:"icon-dict-mw"},{dict:"k",url:"http://www.iciba.com/{word}",text:"iciba \u7231\u8bcd\u9738",iconCls:"icon-dict-k"},{dict:"y",url:"http://dict.youdao.com/search?q={word}&ue=utf8",text:"youdao \u6709\u9053\u8bcd\u5178",iconCls:"icon-dict-y"}];x.forEach(function(a){if(a.dict)x[a.dict]=a});var s=function(a){this.setId(a.id);this.setName(a.name);this.setDesc(a.desc);this.firstload=true;this.setText(a.text,true);this.setFilters(a.filters)};s.fields=[{name:"id",type:"string",title:"Id"},{name:"rate",type:"int",title:"Rate"},{name:"word",type:"string",title:"Word"},{name:"para",type:"string",title:"Paraphrase"},{name:"rmrk",type:"string",title:"Remark"}];s.idIndex=0;s.prototype={setTxtAttr:function(a,b){if(b&&a){a=a.toString();b=b.toString()}else return this;this[a]=b;return this},setId:function(a){return this.setTxtAttr("id",a)},setName:function(a){return this.setTxtAttr("name",a)},setDesc:function(a){return this.setTxtAttr("desc",a)},setText:function(a,b){if(!a)return this;a=a.toString().replace(/\r/i,"").replace(/\s*\t+\s*/,"\t");this.wordlist=null;if(a.length<1)return this;if(this.firstload&&!this.cacheloaded){var c=z.get("wordlist-"+this.id)||[];if(c.length){this.wordlist=c;this.index=z.get("index-"+this.id)||null;this.cacheloaded=true}}this.firstload=false;if(this.wordlist){if(!this.index){this.buildIndex();this.saveIndex()}}else{this.parseText(a,b);this.save();this.saveIndex()}return this},getText:function(){for(var a=this.wordlist.map(function(h){return h.join("\t").replace(/\s+$/,"")}),b=[],c=s.fields,d=0;d<c.length;d++)b.push(c[d].name);a.unshift(b.join("\t"));return a.join("\n")},parseText:function(a,b){for(var c=a.split("\n"),d=c[0].split("\t"),h=s.fields,m=[],k={},l=1,n=0;l<c.length;l++,n++){c[l]=c[l].replace(/\s+$/,"");if(!(c[l].length<1)){c[l]=c[l].split(/\s*\t\s*/);for(var C={},r=[null,-1,null,"",""],o=0;o<d.length;o++)C[d[o]]=c[l][o];if(C.word!=null){for(o=0;o<h.length;o++){var v=h[o].name;if(v in C){r[o]=C[v];if(h[o].type=="int"){r[o]=parseInt(r[o]);if(isNaN(r[o]))r[o]=-1}}}m.push(r);k[r[s.idIndex]]=m.length-1}}}if(m.length<1&&!b)throw Error("Invalid text!");this.wordlist=m;this.index=k},buildIndex:function(){for(var a={},b=0;b<this.wordlist.length;b++)a[this.wordlist[b][s.idIndex]]=b;this.index=a},setFilters:function(a){a=a&&a.length?this.saveFilters(a):[];for(i=0;i<26;i++){var b=String.fromCharCode(65+i);a.push({name:"- "+b+" -",filter:{word:RegExp("^"+b,"i")}})}a=a.concat([{name:"n.",filter:{para:/\bn\.?\s/i}},{name:"v./vt./vi.",filter:{para:/\bv[ti]?\.?\s/i}},{name:"vt.",filter:{para:/\bvt\.?\s/i}},{name:"vi.",filter:{para:/\bvi\.?\s/i}},{name:"a./adj.",filter:{para:/\ba(dj)?\.?\s/i}},{name:"ad./adv.",filter:{para:/\bad?\.?\s/i}},{name:"prep.",filter:{para:/\bprep\.?\s/i}},{name:"pron.",filter:{para:/\bpron\.?\s/i}},{name:"conj.",filter:{para:/\bconj\.?\s/i}},{name:"art.",filter:{para:/\bart\.?\s/i}},{name:"Ongoing",filter:{rate:/^[1-9]$/}},{name:"Reciting",filter:{rate:/^[1-4]$/}},{name:"Beware",filter:{rate:/^[6-9]$/}},{name:"Active \u2605",filter:{rate:/^\d$/}},{name:"Inactive \u2606",filter:{rate:/../}},{name:"Recited \u3007",filter:{rate:0}}]);for(i=1;i<=6;i++)a.push({name:i+" "+Array(i+1).join("\u2605"),filter:{rate:i}});a.push({name:"All",filter:true});this.filters=a;return this},update:function(a,b){if(b==null){this.wordlist[this.index[a]]=undefined;this.index[a]=undefined;this.indexChanged=true}else{if(this.index[a]==null){this.wordlist[this.index[a]=this.wordlist.length]=[];this.indexChanged=true}for(var c=0;c<s.fields.length;c++){var d=b[s.fields[c].name];if(d!=null)this.wordlist[this.index[a]][c]=d}}},saveIndex:function(){z.set("index-"+this.id,this.index)},saveFilters:function(a){z.set("filters-"+this.id,a.map(function(b){var c={name:b.name,filter:{}};if(b.filter===true||b.filter===null)c.filter=b.filter;else if(b.filter instanceof Function)c.filter=b.filter.toString();else for(var d in b.filter)c.filter[d]=b.filter[d].toString();return c}));return a},save:function(){z.set("wordlist-"+this.id,this.wordlist);if(this.indexChanged){this.saveIndex();this.indexChanged=false}}};Ext.data.Record.create(s.fields);var f=new Ext.data.ArrayStore({superclass:Ext.data.ArrayStore.prototype,autoDestroy:true,storeId:"wordlistStore",fields:s.fields,idIndex:s.idIndex,removedRecords:[],changed:0,listeners:{update:R,add:R,remove:function(a,b){this.removedRecords.push(b);R()}},sortReversed:false,sortByLen:false,_reversedCache:{},_cachedRev:function(a){return this._reversedCache[a]||(this._reversedCache[a]=a.split("").reverse().join(""))},createSortFunction:function(a,b){function c(l,n){return l>n?1:l<n?-1:0}b=b||"ASC";var d=b.toUpperCase()=="DESC"?-1:1,h=this.fields.get(a).sortType,m=this,k=this.sortByLen?function(l,n){return c(l.length,n.length)||c(l.length,n.length)}:c;return a=="word"&&this.sortReversed?function(l,n){return d*k(m._cachedRev(l.data.word),m._cachedRev(n.data.word))}:function(l,n){return d*k(h(l.data[a]),h(n.data[a]))}},sortBy:function(a,b){b=b||"ASC";this.data.sort(b,a);this.snapshot&&this.snapshot!=this.data&&this.snapshot.sort(b,a)},prefilter:function(a){if(a=="*")this._prefilter=[];else if(Ext.isFunction(a))this._prefilter=[{fn:a,scope:this}];else{var b=[];a.forEach(function(c){(c=this.createFilterFn(c.property,c.value))&&b.push({fn:c,scope:this})},this);this._prefilter=b}this.filterBy()},filterSearch:function(a,b){if(a==null)this.filterBy();else Ext.isFunction(a)?this.superclass.filterBy.call(this,a,b||this):this.superclass.filterBy.call(this,this.createFilterFn(a,b),this)},filterBy:function(a,b){var c=this._prefilter?this._prefilter.concat([]):[];if(a)this._filter={fn:a,scope:this};this._filter&&c.push(this._filter);return(a=this.createMultipleFilterFn(c))?this.superclass.filterBy.call(this,a,b||this):this.clearFilter()},clearFilter:function(a){this._filter=null;this.superclass.clearFilter.call(this,a)}}),u=new (Ext.extend(Ext.ux.grid.RowEditor,{ignoreNoChange:true,editable:false,once:false,edit:function(a){this.startEditing(a,true,false)},editOnce:function(a){return this.startEditing(a,true,true)},startEditing:function(a,b,c){if(c)this.once=this.editable=true;else if(this.once){this.stopEditing(false);return false}else if(!this.editable)return false;return this.superclass.startEditing.call(this,a,b)},stopEditing:function(a){if(this.once)this.editable=this.once=false;return this.superclass.stopEditing.call(this,a)},initComponent:function(){this.superclass=this.constructor.superclass;this.superclass.initComponent.call(this)}})),L=new Ext.ux.grid.GridFilters({encode:false,local:true,filters:[{type:"string",dataIndex:"id"},{type:"numeric",dataIndex:"rate"},{type:"string",dataIndex:"word"},{type:"string",dataIndex:"para"},{type:"string",dataIndex:"rmrk"}]}),B=new Ext.form.ComboBox({id:"combo-list",store:new Ext.data.ArrayStore({autoDestroy:true,idIndex:0,fields:["id","name"],loaded:false,listeners:{beforeload:function(a){a.loaded=false;a.owner.disable()},load:function(a){a.loaded=true;a.owner.enable()}}}),width:150,allowBlank:false,autoSelect:false,shadow:true,editable:false,disabled:true,triggerAction:"all",mode:"local",displayField:"name",valueField:"id",lastValue:null,stateful:true,stateId:"option",stateEvents:["select"],getState:function(){return j},applyState:function(){this.value="Loading ..."},listeners:{render:function(){this.init()},select:function(){j.wordlist=this.value;if(this.lastValue!=this.value){this.lastValue=this.value;K(this.value)}}},init:function(){var a=this.store.owner=this,b=z.get("wordlist-index")||[];if(b.length)a.store.loadData(b);else{a.store.loadData([]);this.reset();setTimeout(function(){A.show()},100)}},load:function(){if(!this.store.loaded)return false;if(j.wordlist!=null){this.setValue(j.wordlist);var a=this.findRecord("value",this.value);this.fireEvent("select",this,a,this.store.indexOf(a))}else if(this.store.getCount()){j.wordlist=this.store.getAt(0).data.id;this.setValue(j.wordlist);this.fireEvent("select",f,this.store.getAt(0),0)}}}),t=new Ext.form.ComboBox({store:new Ext.data.ArrayStore({autoLoad:false,autoDestroy:true,fields:["name","idx"]}),width:100,allowBlank:false,shadow:true,editable:false,triggerAction:"all",mode:"local",displayField:"name",valueField:"idx",stateful:true,stateId:"option",stateEvents:["change"],getState:function(){return j},applyState:function(){},change:function(a,b){var c=this.store.getCount();if(!c)return false;if(a!=null&&!Ext.isNumber(a)){a=parseInt(a);if(isNaN(a))a=null}if(a==this.value&&!b)return false;if(a==null){this.setRawValue("(Custom)");a===null&&T(true);a=-1}else{a=(a+c)%c;if(a!=this.value||b){this.setRawValue("");this.setValue(a)}q.reset();j.filter[j.wordlist]=this.value;T(a);this.fireEvent("change",a,-1)}g.view.scrollToTop();if(a==0){e.btnFirst.disable();e.btnPrev.disable();e.btnNext.enable();e.btnLast.enable()}else if(a==e.wordlist.cur.filters.length-1){e.btnFirst.enable();e.btnPrev.enable();e.btnNext.disable();e.btnLast.disable()}else{if(a<0){e.btnFirst.enable();e.btnPrev.enable();e.btnNext.disable()}else{e.btnFirst.enable();e.btnPrev.enable();e.btnNext.enable()}e.btnLast.enable()}},listeners:{render:function(){this.el.unselectable()},select:function(){this.change(this.value,true)}},loadFilters:function(a){var b=[],c=this;for(i=0;i<a.length;i++)b.push([a[i].name,i]);c.store.loadData(b);f.on("load",function(){c.change(j.filter[j.wordlist]||0,true)},this,{single:true})}}),q=new Ext.form.ComboBox({id:"search-bar",store:new Ext.data.ArrayStore({autoDestroy:true,fields:["word"]}),width:150,allowBlank:true,shadow:true,editable:true,enableKeyEvents:true,emptyText:"Type to search",mode:"local",displayField:"word",valueField:"word",stateId:"searched",words:[],triggerConfig:{id:"triggerSearch",tag:"img",src:Ext.BLANK_IMAGE_URL,cls:"x-form-trigger x-form-search-trigger"},addHistory:function(a){if(!a)return false;var b=this.words.indexOf(a);b>=0&&this.words.splice(b,1);this.words.unshift(a);this.loadWords();J.set(this.stateId,this.words.join("|"))},clear:function(){t.change(j.filter[j.wordlist],true)},loadWords:function(){q.store.loadData(q.words.map(function(a){return[a]}))},go:function(){e.dlgDict.show(q.getRawValue(),j.defaultDict)},listeners:{render:function(){var a=J.get(this.stateId);if(a&&a.length){this.words=a.split("|");this.loadWords()}Ext.fly("triggerSearch").on("click",q.go)},specialkey:function(a,b){if(b.getKey()==b.ENTER)e.dlgDict.show(a.getRawValue(),j.defaultDict);else if(b.getKey()==b.ESC)this.clear();else return true;b.stopEvent();return false},keyup:function(a){a._timeout=a._timeout&&clearTimeout(a._timeout)||setTimeout(function(){var b=a.getRawValue();if(b.length){f.filterSearch("word",RegExp(b,"i"));t.change();q.focus()}else a.clear()},300)},select:function(){f.filterSearch("word",RegExp(word,"i"));t.change()}}}),D=new Ext.Editor({id:"rmrk-editor",autoSize:false,ignoreNoChange:true,shadow:false,field:{xtype:"textfield",allowBlank:true},to:function(a,b){if(a==null||u.editable)return false;if(b==null)b=5;this.row=a;this.target=Ext.fly(g.view.getCell(a,b).firstChild);this.record=g.getSelectionModel().getSelected();this.startEdit(this.target,this.record.get("rmrk"))},listeners:{beforeshow:function(){this.el.setRegion(this.target.parent().getRegion());this.field.el.setRegion(this.target.parent().getRegion())},complete:function(a,b){this.record.set("rmrk",Ext.util.Format.trim(b))},hide:function(){g.view.focusRow(this.row)}}}),y=new Ext.menu.Menu({id:"para-cmenu",shadow:true,items:[{text:"Edit",iconCls:"icon-edit",handler:function(){if(y.row==null)return false;u.editOnce(y.row)}},{text:"Play Sound",iconCls:"icon-play-sound",handler:function(){if(y.record==null)return false;p(y.record.get("word"))},listeners:{render:function(a){I()||a.disable()}}},{id:"menu-dict",text:"Online Dictionary",handler:function(){if(y.record==null)return false;e.dlgDict.show(y.record.get("word"))}}],syncDict:function(){if(!this.menuDict)return false;var a=x[j.defaultDict];this.menuDict.setText(a.text);this.menuDict.setIconClass(a.iconCls)},listeners:{render:function(){this.menuDict=Ext.getCmp("menu-dict");this.syncDict()},beforeshow:function(){this.syncDict()}}}),M=Ext.extend(Ext.CycleButton,{stateful:true,stateId:"option",stateEvents:["change"],getState:function(){return j},applyState:function(){this.sync()},tooltip:{title:"Online Dictionary",text:"Look up the word in online dictionary<br/><i>Click to switch the Dictionaries.</i>"},items:x,sync:function(a){if(a&&a in x)j.defaultDict=a;var b=this;b.getActiveItem().dict!=j.defaultDict&&Ext.each(b.items,function(c,d){if(c.dict==j.defaultDict){b.setActiveItem(b.menu.items.get(d));return false}});return this},changeHandler:function(a,b){j.defaultDict=b.dict;Ext.each(a.constructor.instances,function(c){c!=a&&c.sync()})},initComponent:function(){x[j.defaultDict].checked=true;this.constructor.superclass.initComponent.call(this);var a=this.constructor.instances||[];if(a.length)this.menu=a[0].menu;a.push(this);this.constructor.instances=a}}),S=new Ext.Spacer({id:"rate-stats",cls:"x-panel-body bae",init:function(){this.rate_stats={stats:[]};for(var a=-1;a<10;a++)this.rate_stats.stats[a+1]=this.rate_stats[a]={title:a+" "+(a==0?"\u3007":a<0?"\u2606":Array(a+1).join("\u2605")),cssCls:"word-row-rate-"+(a<0?"x":a)};f.on("load",this.refresh,this,{single:true,delay:300});g.view.on("refresh",this.refresh,this,{buffer:300});this.relayEvents(this.el,["click"])},calc:function(){var a=this.rate_stats,b=300,c=null,d=f.getCount(),h=e.wordlist.cur.wordlist.length,m=h!=d;a.count=d;a.total=h;a.total_precent=m?"/"+(d/h*100).toFixed(2):"";for(var k=-1;k<10;k++){a[k].sum=d;a[k].count=0}f.each(function(n){n=n.get("rate");if(n<0||n>9)n=-1;a[n].count++});for(k=9;k>=-1;k--){d=a[k];var l=d.count/a.count;if(isNaN(l))l=0;d.precent=(l*100).toFixed(2)+"%";if(m)d.precent+="/"+(d.count/h*100).toFixed(2)+"%";d.width=0;if(d.count){d.width=l*300;if(d.width<=1)d.width=1;else{c=d;d.width=Math.round(d.width)}b-=d.width}}if(b&&c)c.width+=b},_bar_div_t:new Ext.Template('<div class="rate-stats {cssCls}" ext:qtitle="Rate: {title}" ext:qtip="{count}/{sum} ({precent})" style="display:inline-block;width:{width}px;height:20px"></div>',{compiled:true,disableFormats:true}),_table_t:new Ext.XTemplate('<table onmousedown="baeword.grid.el.unmask();return false" style="cursor:default"><caption class="caption">Statistics</caption><tpl for="stats"><tr><td>{title}</td><td>: </td><td>{count}</td><td>({precent})</td></tr></tpl><tr><td>Count (filtered)</td><td>: </td><td>{count}</td><td>(100%{total_precent})</td></tr><tr><td>Total (wordlist)</td><td>: </td><td colspan="2">{total}</td></tr></table>',{compiled:true,disableFormats:true}),refresh:function(){if(f.getCount()){this.calc();for(var a=[],b=9;b>=-1;b--)this.rate_stats[b].count&&a.push(this._bar_div_t.apply(this.rate_stats[b]));this.update(a.join(""))}else this.el.clean()},listeners:{render:function(){this.init()},click:function(){if(f.getCount())g.el.mask(this._table_t.apply(this.rate_stats)).on("mousedown",function(){g.el.unmask()},null,{single:true});else return Q()}}});e.btnSave=new Ext.Toolbar.SplitButton({id:"btnSave",iconCls:"icon-accept",text:"Save",tooltip:{title:"Save changes",text:'Save changes manually or open the Menu.<br/><i>If you do not want always click it manual, enable the "auto save" in menu.</i>'},handler:function(a){if(f.changed){u.stopEditing();w()}else a.showMenu()},menu:{items:[{id:"menuAutoSave",text:"Auto Save",xtype:"menucheckitem",stateful:true,stateId:"option",stateEvents:["checkchange"],getState:function(){return j},applyState:function(a){this.setChecked(a.autosave)},listeners:{checkchange:function(a,b){j.autosave=b;a.setIconClass(b?"icon-accept":null);if(b)f.autosave=setInterval(function(){f.changed&&w()},3E4);else if(f.autosave){clearInterval(f.autosave);f.autosave=null}}}},"-",{id:"menuSound",text:"Auto Sound",xtype:"menucheckitem",iconCls:"icon-sound-off",stateful:true,stateId:"option",stateEvents:["checkchange"],getState:function(){return j},applyState:function(a){if(!I())return false;this.setChecked(a.autosound)},listeners:{checkchange:function(a,b){if(!I()){a.disable();return false}j.autosound=b;a.setIconClass(b?"icon-sound-on":"icon-sound-off")},render:function(a){I()||a.disable()}}},"-",{id:"menuEditable",text:"Editable",xtype:"menucheckitem",iconCls:"icon-not-editable",checkHandler:function(a,b){u.stopEditing();(u.editable=b)?a.setIconClass("icon-editable"):a.setIconClass("icon-not-editable")}},{id:"btnAdd",iconCls:"icon-add",text:"Add",disabled:true},{id:"btnDel",iconCls:"icon-del",text:"Remove",disabled:true},"-",{id:"btnReset",iconCls:"icon-reset",text:"Reset Settings",handler:function(){W(function(){Ext.Msg.show({title:"Reset Settings",msg:'Are you sure to Reset all settings and KEEP your Records?<br/>(Press "YES" Your Records WON\'T BE LOST!<br/>Press "NO" Everything will be reset!)',buttons:Ext.Msg.YESNOCANCEL,icon:Ext.MessageBox.QUESTION,fn:function(a){if(a!="cancel"){a=a=="no";document.cookie="";if(a)localStorage.clear();else{a={};for(var b in localStorage)if(/wordlist-/.test(b))a[b]=localStorage.getItem(b);localStorage.clear();for(b in a)localStorage.setItem(b,a[b])}"sessionStorage"in window&&sessionStorage.clear();j.resetting=true;location.reload()}}})})}},"-",{id:"btnAbout",iconCls:"icon-info",text:"About Info",handler:function(){g.el.mask(e.btnSave.menu._info_t.apply(e.info)).on("mousedown",function(){g.el.unmask()},null,{single:true})}}],_info_t:new Ext.Template('<table onmousedown="baeword.grid.el.unmask();return false" style="font-size:14px;cursor:default"><caption class="caption">{APP_NAME} with {FX_VER}</caption><tr><td></td><td>by {BY}</td></tr><tr style="height:5px"></tr><tr><td class="right">Version: </td><td>{APP_VER} ({CODE_NAME})</td></tr><tr><td class="right">Last Update: </td><td>{LAST_UPDATE}</td></tr></table>',{compiled:true,disableFormats:true})}});var aa=[new Ext.grid.RowNumberer({renderer:function(a,b,c,d){d++;b.attr=String.format('ext:qtip="{0}" style="font-size: {1}px"',d,d>9999||d>999&&7||d>99&&9||12);return d}}),{id:"id",header:"Id",sortable:true,width:50,dataIndex:"id",editor:{xtype:"textfield",readOnly:true,allowBlank:false}},{id:"rate",header:"\u2606",sortable:true,width:30,renderer:function(a,b){var c=a+" ",d;if(a==0){d="\u3007";c+=d}else if(a>0&&a<10){d="\u2605";c+=Array(a+1).join(d)}else{d="\u2606";c+=d}b.attr='ext:qtip="'+c+'"';return d},dataIndex:"rate",editor:{xtype:"textfield",allowBlank:false}},{id:"word",header:"Word",sortable:true,width:120,dataIndex:"word",renderer:function(a,b){if(a.length>11)b.attr='ext:qtip="'+a+'"';return a},editor:{xtype:"textfield",allowBlank:false}},{id:"para",header:"Paraphrase",sortable:true,width:300,dataIndex:"para",renderer:function(a){return String.format('<span ext:qtip="{1}">{0}</span>',a,a.replace(/ (\d+) /g,"<br/>$1 "))},editor:{xtype:"textfield",allowBlank:true}},{id:"rmrk",header:"Remark",sortable:true,width:120,dataIndex:"rmrk",renderer:function(a,b){if(a.replace(/[^\x00-\xff]/g,"xx").length>15)b.attr='ext:qtip="'+a+'"';return a},editor:{xtype:"textfield",allowBlank:true}}],ba=[{iconCls:"icon-book",tooltip:"Wordlist Selection",overflowText:"Wordlists",handler:function(a){A.show(a.el)}}," ",B," ",{tooltip:"Reload",overflowText:"Reload",iconCls:"icon-reload",handler:function(){if(f.changed>0)if(f.autosave){w();K(B.getValue())}else Ext.Msg.show({title:"Lost Changes",msg:"You are going to reload data that the unsaved changes will lost.<br/>Are you sure to do so?",buttons:Ext.Msg.OKCANCEL,fn:function(a){if(a=="ok"){f.rejectChanges();K(B.getValue())}},animEl:"elId",icon:Ext.MessageBox.WARNING});else K(B.getValue())},scope:this},"-",e.btnSave,"->",{text:"Online Dict: ",disabled:true},new M({id:"dict-bar-switch"}),q,"-",{iconCls:"icon-transport",tooltip:{title:"Export and Import wordlist",text:"Export to a well formated page for save or print. <br/>Export to a text for backup and import in the future. <br/>Import wordlist from a text exported by this application."},menu:[{text:"Export displayed to Page",handler:function(){function a(){if(!d.location||d.location.href=="about:blank")return false;h=h&&clearTimeout(h);try{var m=d.document||d.currentDocument;m.writeln('<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />');m.writeln("<title>WordList Export - "+b+"</title>");m.writeln('<style type="text/css">#export td{padding:1px 3px}#export caption{margin:10px 5px 5px}#export .title{font-size:22px;font-weight:bold}#export .subtitle{font-size:16px;font-style:italic}</style>');m.writeln(c);m.close();d.onbeforeunload=function(){return"Are you sure to leave this page?\nWhile you confirmed, this page will simply disappear.\nIf you are trying to refreshing this page, please export again!"};d.onunload=function(){this.onbeforeunload=function(){};this.close()}}catch(k){Ext.Msg.alert("Error","Export HTML failed!<br/>"+k)}}var b=e.wordlist.cur.name+(f.isFiltered()?" ("+t.getRawValue().replace("(Custom)","filtered").replace(/^[\(\uff08](.*)[\)\uff09]$/,"$1")+")":""),c=['<div id="export">','<table border="1">',"<caption>",'<div class="title">Wordlist export from '+b+"</div>",'<div class="subtitle">'+(new Date).toLocaleDateString()+" -- by baeword</div>","</caption>","<tr>"];s.fields.forEach(function(m){c.push("<th>"+m.title+"</th>")});c.push("</tr>");f.each(function(m){c.push("<tr>");s.fields.forEach(function(k){c.push("<td>"+m.get(k.name)+"</td>")});c.push("</tr>")});c.push("</table>");c.push("</div>");c=c.join("\n");var d=window.open("?export"),h=setTimeout(a,1E3);Ext.fly(d).on("load",a)}},{text:"Export wordlist to Text",handler:function(){W("Before Export Confirm","You must save before export!",function(){e.dlgExport.show(g.body)})}},"-",{text:"Import wordlist from Text",handler:function(){e.dlgImport.show(g.body)}}]}];S=[e.btnFirst=new Ext.Button({tooltip:"First",overflowText:"First",iconCls:"icon-filter-first",disabled:true,handler:function(){t.change(0)},scope:this}),e.btnPrev=new Ext.Button({tooltip:"Prev",overflowText:"Prev",iconCls:"icon-filter-prev",disabled:true,handler:function(){var a=/\(custom\)/i.test(t.getRawValue());t.change(j.filter[j.wordlist]-(a?0:1),a)},scope:this}),"-",t,"-",e.btnNext=new Ext.Button({tooltip:"Next",overflowText:"Next",iconCls:"icon-filter-next",disabled:true,handler:function(){t.change(j.filter[j.wordlist]+1)},scope:this}),e.btnLast=new Ext.Button({tooltip:"Last",overflowText:"Last",iconCls:"icon-filter-last",disabled:true,handler:function(){t.change(e.wordlist.cur.filters.length-1)},scope:this}),"-",{tooltip:"Refresh",overflowText:"Refresh",iconCls:"icon-refresh",handler:function(){f.filterBy();f.applySort();g.view.refresh()},scope:this},"->",S];var g=e.grid=new Ext.grid.GridPanel({id:"grid-baeword",store:f,stateful:true,state:{},stateId:"grid-states",bodyCfg:{cls:"x-panel-body bae"},plugins:[u,L],columns:aa,autoExpandColumn:"para",view:new Ext.ux.grid.BufferView({scrollDelay:false,rowHeight:20,getRowClass:function(a){var b=a.get("rate"),c="";if(b<0||b>9)b="x";else if(a.isModified("rate"))c=" word-row-rated";return"word-row-rate-"+b+c}}),sm:new Ext.grid.RowSelectionModel({singleSelect:true,listeners:{rowselect:function(a,b){g.view.focusRow(b);g.view.selectIdx=b;j.autosound&&p(g.getSelectionModel().getSelected().get("word"))}}}),tbar:ba,bbar:S,listeners:{render:function(){g.row_h=g.view.rowHeight+2;g.view.scroller.on("scroll",function(){var a;if(a=this.dom.scrollTop%g.row_h)this.dom.scrollTop-=a});g.view.scroller.on("mousewheel",function(a){if(D.editing){a.stopEvent();return false}var b=-a.getWheelDelta()*g.row_h;if(a.ctrlKey||a.shiftKey||a.altKey)return true;a.stopEvent();this.dom.scrollTop+=b});this.body.on("keyup",function(a){a.key=a.getKey();(a.key>=16||a.key<=18)&&g.selectedEl&&g.selectedEl.removeClass("x-shift-ctrl-alt")});if(Ext.isIE)this.el.dom.onselectstart=function(){return u.editable||D.editing}},afterrender:function(){g.offsetH=g.getHeight()-g.view.scroller.getHeight();this.buildHMenu()},keydown:function(a){if(u.editable||D.editing)return false;var b=a.getKey();if(b==38||b==40){g.view.scroller.dom.scrollTop+=b==38?-g.row_h:g.row_h;g.view.selectIdx&&g.view.ensureVisible(g.view.selectIdx,1,true)}else if(b==37||b==39)H(b==39);else if(b==10||b==13)H();else b==113&&g.view.selectIdx!=null&&u.editOnce(g.view.selectIdx);(g.selectedEl=Ext.fly(g.view.getRow(g.view.selectIdx)))&&(a.shiftKey||a.ctrlKey||a.altKey)&&g.selectedEl.addClass("x-shift-ctrl-alt")},keypress:function(a){if(u.editable||D.editing)return false;var b=a.getKey(),c=null;if(b>=48&&b<=57)c=b-48;else if(b==46||b==47||b==96)c=-1;else if(b==45||b==61||b==43)c=b!=45;else if(b==32||b==34||b==39){c=" ";a.stopEvent()}else if(b==42)c="*";else{var d=arguments.callee;b=String.fromCharCode(a.getCharCode());if(!/\w/.test(b))return false;d._query=d._query?d._query+b:b;d._timeout=d._timeout&&clearTimeout(d._timeout)||setTimeout(function(){d._timeout=null;var h=f.find("word",d._query,0,false,false);d._query="";if(h<0)return Q();g.getSelectionModel().selectRow(h);g.view.ensureVisible(h,0,true)},500);return false}c!=null&&H(c);return false},rowdblclick:function(a,b,c){(document.selection||document.getSelection()).empty();if(!u.editable&&!D.editing){a.getSelectionModel().selectRow(b);H(" ");c.stopEvent();return false}},cellclick:function(a,b,c){if(c==5&&!D.editing){D.to(b,c);return false}},rowcontextmenu:function(a,b,c){if(c.ctrlKey||c.shiftKey||c.altKey)return true;c.stopEvent();a=g.getSelectionModel();a.selectRow(b);y.row=b;y.record=a.getSelected();y.showAt(c.getXY());return false},headercontextmenu:function(a,b,c){if(c.ctrlKey||c.shiftKey||c.altKey||!b)return true;c.stopEvent();g.view.hdCtxIndex=b;g.view.hmenu.showAt(c.getXY());return false}},buildHMenu:function(){function a(k){g[k?"addClass":"removeClass"]("word-inverted-seq")}var b=g.view.hmenu,c=b.addSeparator({hidden:true});b.insert(2,{itemId:"rand_sort_menu",text:"Sort Random",iconCls:"icon-sort-rand",handler:function(){var k={};f.each(function(l){k[l.id]=Math.random()});g.view.clearHeaderSortState();f.sortBy(function(l,n){return k[l.id]-k[n.id]});g.view.refresh()}});var d=b.insert(3,{checked:false,itemId:"word_bylen_menu",text:"Order By Length",hidden:true,stateful:true,stateId:"option",stateEvents:["checkchange"],getState:function(){return j},applyState:function(k){f.sortByLen=this.checked=k.sort_by_len},listeners:{checkchange:function(k,l){f.sortByLen=j.sort_by_len=l;f.singleSort("word",f.sortInfo&&f.sortInfo.field=="word"?f.sortInfo.direction:null)}}}),h=b.insert(4,{checked:false,itemId:"word_inverted_menu",text:"Inverted Sequence",hidden:true,stateful:true,stateId:"option",stateEvents:["checkchange"],getState:function(){return j},applyState:function(k){a(f.sortReversed=this.checked=k.inverted_seq)},listeners:{checkchange:function(k,l){f.sortReversed=j.inverted_seq=l;f.singleSort("word",f.sortInfo&&f.sortInfo.field=="word"?f.sortInfo.direction:null);a(l)}}}),m=b.add({checked:true,itemId:"para_hidden_menu",text:"Always show Paras",hidden:true,stateful:true,stateId:"option",stateEvents:["checkchange"],getState:function(){return j},applyState:function(k){this.setChecked(!k.hidden_para)},listeners:{checkchange:function(k,l){var n=j.hidden_para=!l;g[n?"addClass":"removeClass"]("para-hidden")}}});b.on("beforeshow",function(){var k=g.view.cm.config[g.view.hdCtxIndex].dataIndex;c.setVisible(k=="para");m.setVisible(k=="para");d.setVisible(k=="word");h.setVisible(k=="word")})}}),N=e.dlgDict=new Ext.Window({width:550,height:500,maximizable:true,opacity:1,closeAction:"hide",html:'<iframe id="ifr_dlgDict" border="0" frameBorder="0" marginWidth="0" marginHeight="0" style="background-color:white" src="'+Ext.BLANK_URL+'"></iframe>',tools:[{id:"pin",qtip:"Stay OnTop",hidden:false,handler:function(a,b,c){c.keepOnTop=true;this.hide();c.tools.unpin.show()}},{id:"unpin",qtip:"Restore",hidden:true,handler:function(a,b,c){c.keepOnTop=false;this.hide();c.tools.pin.show()}}],tbar:[{id:"btnBack",iconCls:"icon-go-back",overflowText:"Click here to go back to the original page.",handler:function(){var a=Ext.getDom("ifr_dlgDict");a.src=a.src}},"->",{text:"Search: ",disabled:true},new M({id:"dict-dlg-switch"}),{id:"dict-search-bar",xtype:"combo",store:q.store,width:q.width,allowBlank:q.allowBlank,shadow:q.shadow,editable:q.editable,enableKeyEvents:q.enableKeyEvents,emptyText:q.emptyText,mode:q.mode,displayField:q.displayField,valueField:q.valueField,triggerConfig:{id:"triggerDictSearch",tag:"img",src:Ext.BLANK_IMAGE_URL,cls:"x-form-trigger x-form-search-trigger"},listeners:{render:function(a){Ext.fly("triggerDictSearch").on("click",function(){N.show(a.getRawValue(),j.defaultDict)});M.instances[1].on("change",function(){N.hidden||N.show(a.getRawValue(),j.defaultDict)})},specialkey:function(a,b){if(b.getKey()==b.ENTER){N.show(a.getRawValue(),j.defaultDict);b.stopEvent();return false}}}}],listeners:{afterrender:function(a){if(!a.ifr_dict){a.ifr_dict=Ext.get("ifr_dlgDict");a.ifr_dict.on("load",function(){if(this.getAttribute("src")==Ext.BLANK_URL)return false;a._mask_timeout=a._mask_timeout&&clearTimeout(a._mask_timeout);a.body.unmask()});a.searchBar=Ext.getCmp("dict-search-bar");a.btnBack=Ext.getCmp("btnBack");a.showed=true}},activate:function(){if(this.opacity<1){this.el.setOpacity(this.opacity=1);this.el.clearOpacity()}this.body.unmask()},deactivate:function(){if(this.keepOnTop){this.el.setOpacity(this.opacity=0.7,true);var a=1;this.manager.each(function(){a++});this.setZIndex(this.manager.zseed+a*10)}this.body.mask().setOpacity(0.3)},resize:function(){this.ifr_dict&&this.ifr_dict.setSize(this.getInnerWidth(),this.getInnerHeight());this.showed&&this.toFront()},hide:function(){if(this.ifr_dict)this.ifr_dict.dom.src=Ext.BLANK_URL}},show:function(a,b){if(!a)return false;if(!b)b=j.defaultDict;Ext.Window.prototype.show.call(this);this.word=a=a.replace(/\s*\(.+?\)/g,"");var c=this,d=c.getPosition(),h='<img src="'+Ext.BLANK_IMAGE_URL+'" class="'+x[b].iconCls+'" style="float:left;width:16px;height:16px;margin:0 3px 0 0"/>';d[1]<0&&c.setPosition(d[0],0);c.setTitle(h+a+" - Online Dictionary ["+x[b].text+"]");c.ifr_dict.setSize(c.getInnerWidth(),c.getInnerHeight());c.body.mask("","loading");c._mask_timeout=setTimeout(function(){c._mask_timeout=null;c.body.unmask()},5E3);d=x[b].url;c.ifr_dict.retry=false;c.ifr_dict.dom.src=(Ext.isArray(d)?d[0]:d).replace("{word}",a);c.focus();q.addHistory(a);q.collapse();M.instances[0].sync(b);this.searchBar.setRawValue(a);this.searchBar.collapse();this.btnBack.setText("Reload "+a.bold())}}),A=new Ext.Window({id:"dlg-wordlists",title:"Wordlist Seletion",width:300,autoHeight:true,modal:true,resizable:false,closeAction:"hide",initData:function(a){var b=[],c;for(c in a.data)b.push([c,a.data[c]]);c=new Ext.grid.CheckboxSelectionModel({checkOnly:true});a.grid&&a.grid.destroy();a.grid=new Ext.grid.GridPanel({store:new Ext.data.ArrayStore({autoDestroy:true,idIndex:0,fields:["id","name"],data:b}),frame:false,autoHeight:true,maxHeight:200,enableHdMenu:false,renderTo:a.body,cm:new Ext.grid.ColumnModel({columns:[c,{header:"Wordlist",dataIndex:"name",width:200,sortable:true}]}),sm:c,viewConfig:{forceFit:true},listeners:{viewready:function(d){var h=[],m={};(z.get("wordlist-index")||[]).forEach(function(k){m[k[0]]=true});d.store.each(function(k){k.id in m&&h.push(k)});d.getSelectionModel().selectRecords(h)}}})},listeners:{beforeshow:function(a){if(a.data)this.grid.fireEvent("viewready",this.grid);else{g.el.mask("Loading ...");setTimeout(function(){var b=Date.parse(new Date)/1E3;$load("bae-wordlist-index.js?"+b,function(c){a.data=c;a.initData(a);a.grid.on("viewready",function(){setTimeout(function(){g.el.unmask();a.show(g.el)},300)},null,{single:true})},a,5E3,function(){Ext.Msg.alert("Loading Timeout","Loading Wordlist Index timeout!")},"baeword.load")},100);return false}}},buttonAlign:"left",buttons:[{text:"Reload",handler:function(){A.hide().data=null;A.show()}},"->",{text:"OK",handler:function(){var a=A.grid.getSelectionModel().getSelections().map(function(b){return[b.id,b.data.name]});z.set("wordlist-index",a);setTimeout(function(){B.init();B.load()},300);A.hide()}},{text:"Cancel",handler:function(){A.hide()}}]}),O=e.dlgWebStorage=new Ext.Window({width:550,height:400,modal:true,closeAction:"hide",user:null,url:{base:"http://yyfearth.appspot.com/webstorage/",login:"login",post:"baeword-wordlist-{id}",get:"baeword-wordlist-{id}"},html:'<iframe id="ifr_dlgWebStorage" border="0" frameBorder="0" marginWidth="0" marginHeight="0" style="background-color:white" src="'+Ext.BLANK_URL+'"></iframe><form id="frm_dlgWebStorage" method="post" target="ifr_dlgWebStorage"><input type="hidden" id="ws-title" name="title"/><input type="hidden" id="ws-desc" name="desc"/><input type="hidden" id="ws-data" name="data"/></form>',buttons:[{text:"Close",handler:function(){O.hide()}}],messageHandler:function(a,b,c){switch(b){case "login":a.hide();if(c.user){O.user={email:c.user,nickname:c.nickname};Ext.isFunction(a.onLogined)&&a.onLogined(a,c)}else Ext.Msg.alert("Login Failed","Login Faild for no user info!<br/>please retry.");break;case "post":a.hide();Ext.isFunction(a.onUploaded)&&a.onUploaded(a,c);break;case "get":a.hide();Ext.isFunction(a.onDownloaded)&&a.onDownloaded(a,c);break;default:Ext.Msg.alert("Transmit Message Failed","No such method: "+b)}},login:function(a,b){if(!this.user){var c=this;this.show(b,function(){c.ifr_ws.dom.src=Ext.BLANK_URL;c.hide();var d=setTimeout(function(){d=null;c.show()},1E3);this.setTitle("Login - WebStorage");this.onLogined=function(h){this.onLogined=null;d=d&&clearTimeout(d);Ext.isFunction(a)&&a.call(h,O.user)};c.ifr_ws.dom.src=c.url.base+c.url.login})}},upload:function(a,b){var c=Ext.getDom("frm_dlgWebStorage");if(!this.user){b&&b.call(this,{err:"not login"});return false}Ext.isFunction(b)||(b=null);c.reset();Ext.getDom("ws-title").value="baeword user's wordlist records of "+e.wordlist.cur.name;Ext.getDom("ws-desc").value="(User and Record Info will be displayed here in the futher)\nRecorded at "+(new Date).toLocaleTimeString();Ext.getDom("ws-data").value=a;c.action=this.url.base+this.url.post.replace("{id}",e.wordlist.cur.id);this.setTitle("Uploading... - WebStorage");this.onUploaded=function(d,h){this.onUploaded=null;b&&b.call(d,h)};c.submit()},download:function(a){if(!this.user){a&&a.call(this,{err:"not login"});return false}Ext.isFunction(a)||(a=null);this.setTitle("Downloading... - WebStorage");this.onDownloaded=function(b,c){this.onDownloaded=null;Ext.isFunction(a)&&a.call(b,c)};this.ifr_ws.dom.src=this.url.base+this.url.get.replace("{id}",e.wordlist.cur.id)},init:function(){var a=this;if(!this.ifr_ws){this.ifr_ws=Ext.get("ifr_dlgWebStorage");this.ifr_ws.setSize(this.getInnerWidth(),this.getInnerHeight());this.ifr_ws.on("load",function(){Ext.isFunction(a.onPageLoad)&&a.onPageLoad.call(this)});var b=function(c){var d=["Transmit Message Failed","Transmit Message Faild for {err} error!<br/>please retry."];if(c.data){try{var h=Ext.decode(c.data)}catch(m){}if(h&&h.method)Ext.isFunction(a.messageHandler)&&a.messageHandler(a,h.method.toLowerCase(),h);else Ext.Msg.alert(d[0],d[1].replace("{err}","data or parsing"))}else Ext.Msg.alert(d[0],d[1].replace("{err}","transmit"))};if(window.addEventListener)window.addEventListener("message",b,false);else window.attachEvent&&window.attachEvent("onmessage",b)}},listeners:{afterrender:function(a){a.init()},resize:function(){this.ifr_ws&&this.ifr_ws.setSize(this.getInnerWidth(),this.getInnerHeight())},hide:function(){this.ifr_ws.dom.src=Ext.BLANK_URL}}}),ca=Ext.extend(Ext.form.TextArea,{wordWrap:false,initComponent:Ext.form.TextArea.prototype.initComponent.createSequence(function(){Ext.applyIf(this,{wordWrap:true})}),onRender:Ext.form.TextArea.prototype.onRender.createSequence(function(){this.el.setOverflow("auto");if(this.wordWrap===false)if(Ext.isIE)this.el.dom.wrap="off";else this.el.set({wrap:"off"});this.preventScrollbars===true&&this.el.setStyle("overflow","hidden")})});L=Ext.extend(Ext.Window,{modal:true,width:480,height:450,draggable:false,resizable:false,shadow:true,baseCls:"x-panel",closeAction:"hide",layout:"fit",readonly:false,initComponent:function(){Ext.Window.prototype.initComponent.call(this);this.add(this.txtXport=new ca({readOnly:this.readonly}));this.on("beforeshow",function(){this.setPosition((e.wnd.el.getWidth()-this.getWidth())/2);this.setHeight(e.wnd.el.getHeight()-30)})}});var G=e.dlgImport=new L({id:"dlg-import",title:"Import",listeners:{render:function(a){f.on("load",a.txtXport.reset,a.txtXport)}},buttonAlign:"left",buttons:[{text:"Download from WebStorage",iconCls:"icon-download",handler:function(a){function b(){a.timeout=a.timeout&&clearTimeout(a.timeout);a.disable();a.setIconClass("icon-wait");a.setText("Downloading...");e.dlgWebStorage.download(function(c){a.setIconClass("icon-download");a.enable();if(c.err)c.err=="no_such_name"?Ext.Msg.alert("Download Faild","Download Faild!<br/>No such Recode in WebStorage("+e.dlgWebStorage.user.email+")"):Ext.Msg.alert("Download Faild","Download Faild!<br/>"+c.err);else if(c.data){G.txtXport.setValue(c.data);a.disable();var d=30,h=setInterval(function(){a.setText("You can Download again after "+--d+"s");if(!d){clearInterval(h);a.enable();a.setText("Download from WebStorage("+e.dlgWebStorage.user.email+")")}},1E3);Ext.Msg.alert("Download Success","Download Success!<br/>From WebStorage("+e.dlgWebStorage.user.email+")")}a.setText("Download from WebStorage("+e.dlgWebStorage.user.email+")")})}if(e.dlgWebStorage.user)b();else{a.disable();a.setIconClass("icon-wait");a.setText("Login...");a.timeout=setTimeout(function(){a.timeout=null;a.setIconClass("icon-download");a.setText("Download from WebStorage");a.enable()},5E3);e.dlgWebStorage.hide();e.dlgWebStorage.login(b,a)}}},"->",{text:"Import",iconCls:"icon-accept",handler:function(){var a=G.txtXport.getValue();if(a)if(a=X(a)){Ext.Msg.alert("Import",a+" words Imported!");G.hide()}else Ext.Msg.alert("Import","Failed!");else Ext.Msg.alert("Import","Empty!")}},{text:"Close",handler:function(){G.hide()}}]}),P=e.dlgExport=new L({id:"dlg-export",title:"Export",readonly:true,listeners:{render:function(a){f.on("load",a.txtXport.reset,a.txtXport);f.on("update",a.txtXport.reset,a.txtXport);f.on("add",a.txtXport.reset,a.txtXport);f.on("remove",a.txtXport.reset,a.txtXport)},show:function(a){if(!a.txtXport.getValue()){a.el.mask("Exporting ...");a.txtXport.setValue("...");setTimeout(function(){a.txtXport.setValue(P.text=Y());a.el.unmask()},100)}}},buttonAlign:"left",buttons:[{text:"Upload to WebStorage",iconCls:"icon-upload",handler:function(a){function b(){a.timeout=a.timeout&&clearTimeout(a.timeout);a.disable();a.setIconClass("icon-wait");a.setText("Uploading...");e.dlgWebStorage.upload(c,function(d){a.setIconClass("icon-upload");if(d.err){a.enable();a.setText("Upload to WebStorage("+e.dlgWebStorage.user.email+")");Ext.Msg.alert("Upload Faild","Upload Faild for error:<br/>"+d.err)}else{Ext.Msg.alert("Upload Success","Upload Success!<br/>To WebStorage("+e.dlgWebStorage.user.email+")");a.disable();var h=60,m=setInterval(function(){a.setText("You can Upload again after "+--h+"s");if(!h){clearInterval(m);a.enable();a.setText("Upload to WebStorage("+e.dlgWebStorage.user.email+")")}},1E3)}})}var c=P.txtXport.getValue();if(!c){Ext.Msg.alert("Error","Export Text is empty!");return false}if(e.dlgWebStorage.user)b();else{a.disable();a.setIconClass("icon-wait");a.setText("Login...");a.timeout=setTimeout(function(){a.timeout=null;a.setIconClass("icon-upload");a.setText("Download from WebStorage");a.enable()},5E3);e.dlgWebStorage.hide();e.dlgWebStorage.login(b,a)}}},"->",{text:"OK",handler:function(){P.hide()}}]});e.wnd=new Ext.Window({id:"wnd-baeword",title:"baeword",iconCls:"icon-baeword",x:50,y:50,height:491,width:650,minHeight:118,minWidth:560,minimizable:true,maximizable:true,monitorResize:true,autoShow:true,onEsc:Ext.emptyFn,baseCls:"x-panel",grid:g,stateful:true,stateId:"wnd-states",stateEvents:["resize","move","restore","beforeclose"],getState:function(){var a=Ext.Window.superclass.getState.call(this)||{};if(this.maximized||this.collapsed){a.x=this.restorePos[0];a.y=this.restorePos[1];a=Ext.apply(a,this.restoreSize)}else a=Ext.apply(a,this.getBox(true));a.maximized=!!this.maximized;return a},listeners:{render:function(){this._autoShow=this.autoShow;this.autoShow=false;g.render(this.body);g.bwrap.addClass("x-panel-mc").setStyle("padding","0px");this.resizable=false;this.resizer=new Ext.Resizable(this.el,{window:this,minWidth:this.minWidth,minHeight:this.minHeight,handles:this.resizeHandles||"all",transparent:true,pinned:true,resizeElement:this.resizerAction,handleCls:"x-window-handle",listeners:{resize:function(a,b,c){a=this.window.offsetH+Math.round((c-this.window.offsetH)/g.row_h)*g.row_h;this.window.getHeight()!=a&&this.window.setHeight(a);this.window.showed&&this.window.toFront()}}});this.mon(this.resizer,"beforeresize",this.beforeResize,this);P.render(this.el);G.render(this.el);O.render(this.el);A.render(this.el)},afterrender:function(a){if(this._autoShow){this.autoShow=true;a.show()}},show:function(){this.offsetH=this.getHeight()-g.view.scroller.getHeight();this.maximized||this.resizer.fireEvent("resize",this.resizer,this.width,this.height,null);if(!this.showed){this.toBack();this.showed=true}},resize:function(){var a=this.getInnerHeight();if(this.maximized)a-=(a-g.offsetH+3)%g.row_h;g.setSize(this.getInnerWidth(),a)},restore:function(){g.setSize(this.getInnerWidth(),this.getInnerHeight())},beforeclose:function(){if(f.changed>0)if(f.autosave){w();E()}else Ext.Msg.show({title:"Save before close",msg:"You have unsaved changes.<br/>Close the baeword and Save the changes?<br/><i>Click Yes, changes will be saved and the entire window(page) will be closed;<br/>Click No, the entire window(page) will be closed without save;<br/>Click Cancel, this dialog will disappear and noting will happen.</i>",buttons:Ext.Msg.YESNOCANCEL,fn:function(a){if(a=="yes"){w();E(true)}else a=="no"&&E(true)},icon:Ext.MessageBox.WARNING});else E();return false},minimize:function(){this.hide()}}});e.beep=Q;var Z=U;Ext.fly(window).on("beforeunload",function(){if(!j.resetting){F.set("option",j);J.set("fixurl",p.fixurl);if(f.changed>0)if(f.autosave)w();else return"You are going to leave baeword without saving any changes. \nAre you sure to do so?"}});Ext.onReady(function(){Ext.QuickTips.init();Ext.apply(Ext.QuickTips.getQuickTip(),{showDelay:750,dismissDelay:15E3});/MSIE [78]/i.test(navigator.userAgent)&&Ext.Msg.alert("Performance Warnning",'This application cannot work properly under you browser:<br/><b>Microsoft Internet Explorer 8.0</b> (or Compatibility View)<br/>For its low JS performance. <br/>It might work, but extremely slow or even crash during using!<br/>(<a href="browsers.html">We recommend you switch your browser to use this WebApp</a>)');Ext.fly("desktop").addClass("ready").setHeight(window.innerHeight||document.documentElement.clientHeight);Ext.fly(window).on("resize",function(){var a=window.innerWidth||document.documentElement.clientWidth||document.body.offsetWidth,b=window.innerHeight||document.documentElement.clientHeight||document.body.offsetHeight;Ext.fly("desktop").setSize(a,b)});e.wnd.render("desktop");e.wnd.body.mask().addClass("mask-wait");setTimeout(function(){if(B.store.loaded){e.wnd.body.unmask();B.load()}else setTimeout(arguments.callee,100)},800)})})(window.baeword);
